From 9e4a5b6194fc05f70620bf75e1121d723fef4ee8 Mon Sep 17 00:00:00 2001
From: bitnukl <bitnukl@main.lan>
Date: Tue, 19 Jul 2016 17:04:55 +0200
Subject: [PATCH] switch autoupdater from wget to curl

---
 admin/autoupdater/Makefile                   | 2 +-
 admin/autoupdater/files/usr/sbin/autoupdater | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/admin/autoupdater/Makefile b/admin/autoupdater/Makefile
index 5f13db4..c409c26 100644
--- a/admin/autoupdater/Makefile
+++ b/admin/autoupdater/Makefile
@@ -10,7 +10,7 @@ include $(INCLUDE_DIR)/package.mk
 define Package/autoupdater
   SECTION:=admin
   CATEGORY:=Administration
-  DEPENDS:=+lua-platform-info +libuci-lua +luci-lib-nixio +ecdsautils +!BUSYBOX_CONFIG_SHA512SUM:coreutils-sha512sum
+  DEPENDS:=+lua-platform-info +libuci-lua +luci-lib-nixio +ecdsautils +curl +!BUSYBOX_CONFIG_SHA512SUM:coreutils-sha512sum
   TITLE:=Automatically update firmware
 endef
 
diff --git a/admin/autoupdater/files/usr/sbin/autoupdater b/admin/autoupdater/files/usr/sbin/autoupdater
index 0bbc919..e6041f9 100755
--- a/admin/autoupdater/files/usr/sbin/autoupdater
+++ b/admin/autoupdater/files/usr/sbin/autoupdater
@@ -131,7 +131,7 @@ local function read_manifest(mirror)
 
   -- Read all lines from the manifest
   -- The upper part is saves to lines, the lower part to sigs
-  for line in io.popen(string.format("exec wget -T 120 -O- '%s/%s.manifest'", mirror, branch.name), 'r'):lines() do
+  for line in io.popen(string.format("exec curl -m 300 -o- '%s/%s.manifest'", mirror, branch.name), 'r'):lines() do
     if not sep then
       if line == '---' then
         sep = true
@@ -194,7 +194,7 @@ end
 
 -- Downloads the firmware image from a mirror to a given output file
 local function fetch_firmware(mirror, filename, output)
-  if autoupdater_util.exec('wget', '-T', '120', '-O', output, mirror .. '/' .. filename) ~= 0 then
+  if autoupdater_util.exec('curl', '-m', '3000', '-o', output, mirror .. '/' .. filename) ~= 0 then
     io.stderr:write('Error downloading the image from ' .. mirror .. '\n')
     return false
   end
-- 
2.5.5

